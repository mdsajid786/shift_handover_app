{% extends 'base.html' %}
{% block content %}
<div class="container mt-4">
    <h2>User Management</h2>
    <form method="post" class="mb-4">
        <input type="hidden" name="action" value="add">
        <div class="row g-2 align-items-end">
            <div class="col-md-2">
                <label>Username</label>
                <input type="text" name="username" class="form-control" required>
            </div>
            <div class="col-md-2">
                <label>Password</label>
                <input type="password" name="password" class="form-control" required>
            </div>
                <div class="col-md-2" id="role-group">
                <label>Role</label>
                <select name="role" class="form-select" required>
                    <option value="user">User</option>
                    <option value="team_admin">Team Admin</option>
                    <option value="account_admin">Account Admin</option>
                    <option value="super_admin">Super Admin</option>
                </select>
            </div>
                <div class="col-md-2" id="account-group">
                <label>Account</label>
                <select name="account_id" class="form-select" id="account_id" required>
                    <option value="">Select Account</option>
                    {% for account in accounts %}
                        <option value="{{ account.id }}">{{ account.name }}</option>
                    {% endfor %}
                </select>
            </div>
                <div class="col-md-2" id="team-group">
                <label>Team</label>
                <select name="team_id" class="form-select" id="team_id">
                    <option value="">(None)</option>
                    {% for team in teams %}
                        <option value="{{ team.id }}" data-account="{{ team.account_id }}">{{ team.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-primary">Add User</button>
            </div>
        </div>
            <script>
            // Filter teams by selected account
            document.getElementById('account_id').addEventListener('change', function() {
                var selectedAccount = this.value;
                var teamSelect = document.getElementById('team_id');
                var options = teamSelect.options;
                for (var i = 0; i < options.length; i++) {
                    var opt = options[i];
                    if (!opt.value) { opt.style.display = ''; continue; }
                    if (opt.getAttribute('data-account') === selectedAccount) {
                        opt.style.display = '';
                    } else {
                        opt.style.display = 'none';
                    }
                }
                teamSelect.value = '';
            });

            // Hide/show account/team fields based on role
            function updateRoleFields() {
                var roleSelect = document.querySelector('select[name="role"]');
                var role = roleSelect.value;
                var accountGroup = document.getElementById('account-group');
                var teamGroup = document.getElementById('team-group');
                if (role === 'super_admin') {
                    accountGroup.style.display = 'none';
                    teamGroup.style.display = 'none';
                } else if (role === 'account_admin') {
                    accountGroup.style.display = '';
                    teamGroup.style.display = 'none';
                } else {
                    accountGroup.style.display = '';
                    teamGroup.style.display = '';
                }
            }
            document.querySelector('select[name="role"]').addEventListener('change', updateRoleFields);
            // Initial call
            updateRoleFields();
            </script>
    </form>
    <table class="table table-bordered table-hover">
        <thead class="table-light">
            <tr>
                <th>Username</th>
                <th>Role</th>
                <th>Account</th>
                <th>Team</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for user in users %}
            <tr>
                <td>{{ user.username }}</td>
                <td>{{ user.role }}</td>
                <td>{% for account in accounts %}{% if account.id == user.account_id %}{{ account.name }}{% endif %}{% endfor %}</td>
                <td>{% for team in teams %}{% if team.id == user.team_id %}{{ team.name }}{% endif %}{% endfor %}</td>
                <td>
                    {% set can_manage = false %}
                    {% if current_user.role == 'super_admin' %}
                        {% set can_manage = true %}
                    {% elif current_user.role == 'account_admin' and user.account_id == current_user.account_id %}
                        {% set can_manage = true %}
                    {% elif current_user.role == 'team_admin' and user.account_id == current_user.account_id and user.team_id == current_user.team_id %}
                        {% set can_manage = true %}
                    {% endif %}
                    {% if can_manage and user.username != 'admin' %}
                    <form method="post" class="d-inline">
                        <input type="hidden" name="action" value="delete">
                        <input type="hidden" name="user_id" value="{{ user.id }}">
                        <button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
                    </form>
                    <form method="post" class="d-inline">
                        <input type="hidden" name="action" value="update">
                        <input type="hidden" name="user_id" value="{{ user.id }}">
                        <select name="role" class="form-select form-select-sm d-inline w-auto">
                            <option value="user" {% if user.role == 'user' %}selected{% endif %}>User</option>
                            <option value="team_admin" {% if user.role == 'team_admin' %}selected{% endif %}>Team Admin</option>
                            <option value="account_admin" {% if user.role == 'account_admin' %}selected{% endif %}>Account Admin</option>
                            <option value="super_admin" {% if user.role == 'super_admin' %}selected{% endif %}>Super Admin</option>
                        </select>
                        <button type="submit" class="btn btn-sm btn-outline-success">Update</button>
                    </form>
                    {% else %}
                    <span class="text-muted">Protected</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}
